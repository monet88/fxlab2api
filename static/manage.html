<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console - Flow2API</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes slide-up{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
        .animate-slide-up{animation:slide-up .3s ease-out}
        .tab-btn{transition:all .2s ease}
    </style>
    <script>
        tailwind.config={theme:{extend:{colors:{border:"hsl(0 0% 89%)",input:"hsl(0 0% 89%)",ring:"hsl(0 0% 3.9%)",background:"hsl(0 0% 100%)",foreground:"hsl(0 0% 3.9%)",primary:{DEFAULT:"hsl(0 0% 9%)",foreground:"hsl(0 0% 98%)"},secondary:{DEFAULT:"hsl(0 0% 96.1%)",foreground:"hsl(0 0% 9%)"},muted:{DEFAULT:"hsl(0 0% 96.1%)",foreground:"hsl(0 0% 45.1%)"},destructive:{DEFAULT:"hsl(0 84.2% 60.2%)",foreground:"hsl(0 0% 98%)"}}}}}
    </script>
</head>
<body class="h-full bg-background text-foreground antialiased">
    <!-- Navigation -->
    <header class="sticky top-0 z-50 w-full border-b border-border/40 bg-background/95 backdrop-blur">
        <div class="mx-auto flex h-14 max-w-7xl items-center px-6">
            <div class="mr-4 flex items-baseline gap-3">
                <span class="font-bold text-xl">Flow2API</span>
            </div>
            <div class="flex flex-1 items-center justify-end gap-3">
                <a href="https://github.com/TheSmallHanCat/flow2api" target="_blank" class="inline-flex items-center justify-center text-xs transition-colors hover:bg-accent hover:text-accent-foreground h-7 px-2.5" title="GitHub Repository">
                    <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v 3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                    </svg>
                </a>
                <button onclick="logout()" class="inline-flex items-center justify-center text-xs transition-colors hover:bg-accent hover:text-accent-foreground h-7 px-2.5 gap-1">
                    <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    Logout
                </button>
            </div>
        </div>
    </header>

    <main class="mx-auto max-w-7xl px-6 py-6">
        <!-- Tab Navigation -->
        <div class="border-b border-border mb-6">
            <nav class="flex space-x-8">
                <button onclick="switchTab('tokens')" id="tabTokens" class="tab-btn border-b-2 border-primary text-sm font-medium py-3 px-1">Token Management</button>
                <button onclick="switchTab('settings')" id="tabSettings" class="tab-btn border-b-2 border-transparent text-sm font-medium py-3 px-1">System Settings</button>
                <button onclick="switchTab('logs')" id="tabLogs" class="tab-btn border-b-2 border-transparent text-sm font-medium py-3 px-1">Request Logs</button>
            </nav>
        </div>

        <!-- Token Management Panel -->
        <div id="panelTokens">
            <!-- Statistics Cards -->
            <div class="grid gap-4 grid-cols-2 md:grid-cols-5 mb-6">
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">Total Tokens</p>
                    <h3 class="text-xl font-bold" id="statTotal">-</h3>
                </div>
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">Active Tokens</p>
                    <h3 class="text-xl font-bold text-green-600" id="statActive">-</h3>
                </div>
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">Today Images / Total</p>
                    <h3 class="text-xl font-bold text-blue-600" id="statImages">-</h3>
                </div>
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">Today Videos / Total</p>
                    <h3 class="text-xl font-bold text-purple-600" id="statVideos">-</h3>
                </div>
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">Today Errors / Total</p>
                    <h3 class="text-xl font-bold text-destructive" id="statErrors">-</h3>
                </div>
            </div>

            <!-- Token List -->
            <div class="rounded-lg border border-border bg-background">
                <div class="flex items-center justify-between gap-4 p-4 border-b border-border">
                    <h3 class="text-lg font-semibold">Token List</h3>
                    <div class="flex items-center gap-3">
                        <!-- Auto Refresh ATÊ†áÁ≠æÂíåÂºÄÂÖ≥ -->
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-muted-foreground">Auto Refresh AT</span>
                            <div class="relative inline-flex items-center group">
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="atAutoRefreshToggle" onchange="toggleATAutoRefresh()" class="sr-only peer">
                                    <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                                </label>
                                <!-- ÊÇ¨ÊµÆÊèêÁ§∫ -->
                                <div class="absolute bottom-full mb-2 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white text-xs rounded px-2 py-1 whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Auto refresh AT using ST when token expires in less than 1 hour
                                    <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                                </div>
                            </div>
                        </div>
                        <button onclick="refreshTokens()" class="inline-flex items-center justify-center rounded-md transition-colors hover:bg-accent h-8 w-8" title="Refresh">
                            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                            </svg>
                        </button>
                        <button onclick="exportTokens()" class="inline-flex items-center justify-center rounded-md bg-blue-600 text-white hover:bg-blue-700 h-8 px-3" title="Export All Tokens">
                            <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            <span class="text-sm font-medium">Export</span>
                        </button>
                        <button onclick="openImportModal()" class="inline-flex items-center justify-center rounded-md bg-green-600 text-white hover:bg-green-700 h-8 px-3" title="Import Tokens">
                            <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            <span class="text-sm font-medium">Import</span>
                        </button>
                        <button onclick="openAddModal()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-8 px-3">
                            <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            <span class="text-sm font-medium">Add New</span>
                        </button>
                    </div>
                </div>
                
                <div class="relative w-full overflow-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-border">
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Email</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Status</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Expires</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Credits</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Type</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Project Name</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Project ID</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Image</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Video</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Error</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Remark</th>
                                <th class="h-10 px-3 text-right align-middle font-medium text-muted-foreground">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tokenTableBody" class="divide-y divide-border">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- System SettingsÈù¢Êùø -->
        <div id="panelSettings" class="hidden">
            <div class="grid gap-6 lg:grid-cols-2">
                <!-- Security Settings -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <h3 class="text-lg font-semibold mb-4">Security Settings</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium mb-2 block">Admin Username</label>
                            <input id="cfgAdminUsername" type="text" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                            <p class="text-xs text-muted-foreground mt-1">Admin Username</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium mb-2 block">Old Password</label>
                            <input id="cfgOldPassword" type="password" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="ËæìÂÖ•Old Password">
                        </div>
                        <div>
                            <label class="text-sm font-medium mb-2 block">New Password</label>
                            <input id="cfgNewPassword" type="password" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="ËæìÂÖ•New Password">
                        </div>
                        <button onclick="updateAdminPassword()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 w-full">Change Password</button>
                    </div>
                </div>

                <!-- API Key Settings -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <h3 class="text-lg font-semibold mb-4">API Key Settings</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium mb-2 block">Current API Key</label>
                            <input id="cfgCurrentAPIKey" type="text" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" readonly disabled>
                            <p class="text-xs text-muted-foreground mt-1">Current API Key (read-only)</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium mb-2 block">New API Key</label>
                            <input id="cfgNewAPIKey" type="text" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="Enter new API Key">
                            <p class="text-xs text-muted-foreground mt-1">API key for client calls</p>
                        </div>
                        <button onclick="updateAPIKey()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 w-full">Êõ¥New API Key</button>
                    </div>
                </div>

                <!-- Proxy Settings -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <h3 class="text-lg font-semibold mb-4">Proxy Settings</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="cfgProxyEnabled" class="h-4 w-4 rounded border-input">
                                <span class="text-sm font-medium">Enable Proxy</span>
                            </label>
                        </div>
                        <div>
                            <label class="text-sm font-medium mb-2 block">Proxy URL</label>
                            <input id="cfgProxyUrl" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="http://127.0.0.1:7890 Êàñ socks5://127.0.0.1:1080">
                            <p class="text-xs text-muted-foreground mt-1">Supports HTTP and SOCKS5 proxy</p>
                        </div>
                        <button onclick="saveProxyConfig()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 w-full">Save Config</button>
                    </div>
                </div>

                <!-- ErrorÂ§ÑÁêÜÈÖçÁΩÆ -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <h3 class="text-lg font-semibold mb-4">ErrorÂ§ÑÁêÜÈÖçÁΩÆ</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium mb-2 block">ErrorÂ∞ÅÁ¶ÅÈòàÂÄº</label>
                            <input id="cfgErrorBan" type="number" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="3">
                            <p class="text-xs text-muted-foreground mt-1">Token ËøûÁª≠ErrorËææÂà∞Ê≠§Ê¨°Êï∞ÂêéËá™Âä®Disable</p>
                        </div>
                        <button onclick="saveAdminConfig()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 w-full">Save Config</button>
                    </div>
                </div>

                <!-- Cache Settings -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <h3 class="text-lg font-semibold mb-4">Cache Settings</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="cfgCacheEnabled" class="h-4 w-4 rounded border-input" onchange="toggleCacheOptions()">
                                <span class="text-sm font-medium">Enable Cache</span>
                            </label>
                            <p class="text-xs text-muted-foreground mt-1">ÂÖ≥Èó≠ÂêéÔºåÁîüÊàêÁöÑImageÂíåVideoÂ∞ÜÁõ¥Êé•ËæìÂá∫ÂéüÂßãÈìæÊé•Ôºå‰∏ç‰ºöÁºìÂ≠òÂà∞Êú¨Âú∞</p>
                        </div>

                        <!-- Cache SettingsÈÄâÈ°π -->
                        <div id="cacheOptions" style="display: none;" class="space-y-4 pt-4 border-t border-border">
                            <div>
                                <label class="text-sm font-medium mb-2 block">Cache Timeout (seconds)</label>
                                <input id="cfgCacheTimeout" type="number" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="7200" min="60" max="86400">
                                <p class="text-xs text-muted-foreground mt-1">File cache timeout, range: 60-86400 seconds (1 minute - 24 hours)</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium mb-2 block">Cache File Access Domain</label>
                                <input id="cfgCacheBaseUrl" type="text" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="https://yourdomain.com">
                                <p class="text-xs text-muted-foreground mt-1">Leave empty to use server address, e.g.: https://yourdomain.com</p>
                            </div>
                            <div id="cacheEffectiveUrl" class="rounded-md bg-muted p-3 hidden">
                                <p class="text-xs text-muted-foreground">
                                    <strong>üåê Current effective access URL:</strong><code id="cacheEffectiveUrlValue" class="bg-background px-1 py-0.5 rounded"></code>
                                </p>
                            </div>
                        </div>

                        <button onclick="saveCacheConfig()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 w-full">Save Config</button>
                    </div>
                </div>

                <!-- Captcha Settings -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <h3 class="text-lg font-semibold mb-4">Captcha Settings</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium mb-2 block">Captcha Method</label>
                            <select id="cfgCaptchaMethod" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" onchange="toggleCaptchaOptions()">
                                <option value="yescaptcha">YesCaptcha</option>
                                <option value="browser">Headless Browser</option>
                                <option value="personal">Built-in Browser</option>
                            </select>
                            <p class="text-xs text-muted-foreground mt-1">Select captcha solving method</p>
                        </div>

                        <!-- YesCaptchaÈÖçÁΩÆÈÄâÈ°π -->
                        <div id="yescaptchaOptions" class="space-y-4">
                            <div>
                                <label class="text-sm font-medium mb-2 block">YesCaptcha API Key</label>
                                <input id="cfgYescaptchaApiKey" type="text" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="ËØ∑ËæìÂÖ•YesCaptcha API Key">
                                <p class="text-xs text-muted-foreground mt-1">For auto-solving reCAPTCHA, leave empty to skip captcha</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium mb-2 block">YesCaptcha API URL</label>
                                <input id="cfgYescaptchaBaseUrl" type="text" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="https://api.yescaptcha.com">
                                <p class="text-xs text-muted-foreground mt-1">YesCaptcha service URL, default: https://api.yescaptcha.com</p>
                            </div>
                        </div>

                        <!-- ÊµèËßàÂô®ÊâìÁ†ÅÈÖçÁΩÆÈÄâÈ°π -->
                        <div id="browserCaptchaOptions" class="hidden space-y-4">
                            <div class="rounded-md bg-blue-50 dark:bg-blue-900/20 p-3 border border-blue-200 dark:border-blue-800">
                                <p class="text-xs text-blue-800 dark:text-blue-200">
                                    ‚ÑπÔ∏è <strong>Browser Captcha:</strong>Uses Playwright automated browser for captcha, no extra config needed but uses more system resources
                                </p>
                            </div>

                            <div>
                                <label class="inline-flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="cfgBrowserProxyEnabled" class="h-4 w-4 rounded border-input" onchange="toggleBrowserProxyInput()">
                                    <span class="text-sm font-medium">Enable Proxy</span>
                                </label>
                                <p class="text-xs text-muted-foreground mt-2">Configure separate proxy for headless browser</p>
                            </div>

                            <div id="browserProxyUrlInput" class="hidden">
                                <label class="text-sm font-medium mb-2 block">Proxy URL</label>
                                <input id="cfgBrowserProxyUrl" type="text" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="http://host:port Êàñ socks5://host:port">
                                <p class="text-xs text-muted-foreground mt-1">
                                    ‚ö†Ô∏è <strong>Only supports:</strong>HTTP proxy (with auth) or SOCKS5 proxy (without auth)<br>
                                    Example:<code class="bg-muted px-1 py-0.5 rounded">http://user:pass@proxy.com:8080</code> Êàñ <code class="bg-muted px-1 py-0.5 rounded">socks5://proxy.com:1080</code>
                                </p>
                            </div>
                        </div>

                        <button onclick="saveCaptchaConfig()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 w-full">Save Config</button>
                    </div>
                </div>

                <!-- Plugin Connection Settings -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <h3 class="text-lg font-semibold mb-4">Plugin Connection Settings</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-semibold mb-2 block">Connection URL</label>
                            <div class="flex gap-2">
                                <input id="cfgPluginConnectionUrl" type="text" readonly class="flex h-9 flex-1 rounded-md border border-input bg-muted px-3 py-2 text-sm" placeholder="Loading...">
                                <button onclick="copyConnectionUrl()" class="inline-flex items-center justify-center rounded-md bg-secondary text-secondary-foreground hover:bg-secondary/80 h-9 px-4">Copy</button>
                            </div>
                            <p class="text-xs text-muted-foreground mt-1">Chrome extension plugin needs this URL configured</p>
                        </div>
                        <div>
                            <label class="text-sm font-semibold mb-2 block">Connection Token</label>
                            <div class="flex gap-2">
                                <input id="cfgPluginConnectionToken" type="text" class="flex h-9 flex-1 rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="Leave empty to auto-generate">
                                <button onclick="copyConnectionToken()" class="inline-flex items-center justify-center rounded-md bg-secondary text-secondary-foreground hover:bg-secondary/80 h-9 px-4">Copy</button>
                            </div>
                            <p class="text-xs text-muted-foreground mt-1">For Chrome extension authentication, leave empty to auto-generate random token</p>
                        </div>
                        <div>
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="cfgAutoEnableOnUpdate" class="h-4 w-4 rounded border-input">
                                <span class="text-sm font-medium">Auto-enable on token update</span>
                            </label>
                            <p class="text-xs text-muted-foreground mt-2">When plugin updates a disabled token, auto-enable it</p>
                        </div>
                        <div class="rounded-md bg-blue-50 dark:bg-blue-900/20 p-3 border border-blue-200 dark:border-blue-800">
                            <p class="text-xs text-blue-800 dark:text-blue-200">
                                ‚ÑπÔ∏è <strong>Usage:</strong>ÂÆâË£ÖChromeÊâ©Â±ïÂêéÔºåÂ∞ÜConnection URLÂíåTokenÈÖçÁΩÆÂà∞Êèí‰ª∂‰∏≠ÔºåÊèí‰ª∂‰ºöËá™Âä®ÊèêÂèñGoogle LabsÁöÑcookieÂπ∂UpdateÂà∞Á≥ªÁªü
                            </p>
                        </div>
                        <button onclick="savePluginConfig()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 w-full">Save Config</button>
                    </div>
                </div>

                <!-- Generation Timeout Settings -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <h3 class="text-lg font-semibold mb-4">Generation Timeout Settings</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium mb-2 block">ImageÁîüÊàêË∂ÖÊó∂TimeÔºàsÔºâ</label>
                            <input id="cfgImageTimeout" type="number" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="300" min="60" max="3600">
                            <p class="text-xs text-muted-foreground mt-1">ImageÁîüÊàêË∂ÖÊó∂TimeÔºåËåÉÂõ¥Ôºö60-3600 sÔºà1min-1hourÔºâÔºåË∂ÖÊó∂ÂêéËá™Âä®ÈáäÊîæTokenÈîÅ</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium mb-2 block">VideoÁîüÊàêË∂ÖÊó∂TimeÔºàsÔºâ</label>
                            <input id="cfgVideoTimeout" type="number" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="1500" min="60" max="7200">
                            <p class="text-xs text-muted-foreground mt-1">VideoÁîüÊàêË∂ÖÊó∂TimeÔºåËåÉÂõ¥Ôºö60-7200 sÔºà1min-2hourÔºâÔºåË∂ÖÊó∂ÂêéËøîÂõû‰∏äÊ∏∏APIË∂ÖÊó∂Error</p>
                        </div>
                        <button onclick="saveGenerationTimeout()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 w-full">Save Config</button>
                    </div>
                </div>

                <!-- Debug Settings -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <h3 class="text-lg font-semibold mb-4">Debug Settings</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="cfgDebugEnabled" class="h-4 w-4 rounded border-input" onchange="toggleDebugMode()">
                                <span class="text-sm font-medium">Enable Debug Mode</span>
                            </label>
                            <p class="text-xs text-muted-foreground mt-2">When enabled, detailed upstream API request and response logs will be written to <code class="bg-muted px-1 py-0.5 rounded">logs.txt</code> file</p>
                        </div>
                        <div class="rounded-md bg-yellow-50 dark:bg-yellow-900/20 p-3 border border-yellow-200 dark:border-yellow-800">
                            <p class="text-xs text-yellow-800 dark:text-yellow-200">
                                ‚ö†Ô∏è <strong>Note:</strong>Debug mode produces extremely large amounts of logs, only enable for debugging or disk will boom
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Request LogsÈù¢Êùø -->
        <div id="panelLogs" class="hidden">
            <div class="rounded-lg border border-border bg-background">
                <div class="flex items-center justify-between gap-4 p-4 border-b border-border">
                    <h3 class="text-lg font-semibold">Request Logs</h3>
                    <div class="flex gap-2">
                        <button onclick="clearAllLogs()" class="inline-flex items-center justify-center rounded-md transition-colors hover:bg-red-50 hover:text-red-700 h-8 px-3 text-sm" title="Clear Logs">
                            <svg class="h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                            Clear
                        </button>
                        <button onclick="refreshLogs()" class="inline-flex items-center justify-center rounded-md transition-colors hover:bg-accent h-8 w-8" title="Refresh">
                            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="relative w-full overflow-auto max-h-[600px]">
                    <table class="w-full text-sm">
                        <thead class="sticky top-0 bg-background">
                            <tr class="border-b border-border">
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Actions</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">TokenEmail</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Status code</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Duration(s)</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Time</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Details</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody" class="divide-y divide-border">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Êó•ÂøóDetailsÊ®°ÊÄÅÊ°Ü -->
        <div id="logDetailModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
            <div class="bg-background rounded-lg border border-border w-full max-w-3xl shadow-xl max-h-[80vh] flex flex-col">
                <div class="flex items-center justify-between p-5 border-b border-border">
                    <h3 class="text-lg font-semibold">Êó•ÂøóDetails</h3>
                    <button onclick="closeLogDetailModal()" class="text-muted-foreground hover:text-foreground">
                        <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="p-5 overflow-y-auto">
                    <div id="logDetailContent" class="space-y-4">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-12 pt-6 border-t border-border text-center text-xs text-muted-foreground">
            <p>¬© 2025 <a href="https://linux.do/u/thesmallhancat/summary" target="_blank" class="no-underline hover:underline" style="color: inherit;">TheSmallHanCat</a> && <a href="https://linux.do/u/tibbar/summary" target="_blank" class="no-underline hover:underline" style="color: inherit;">Tibbar</a>. All rights reserved.</p>
        </footer>
    </main>

    <!-- Add Token Ê®°ÊÄÅÊ°Ü -->
    <div id="addModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-background rounded-lg border border-border w-full max-w-2xl shadow-xl my-auto">
            <div class="flex items-center justify-between p-5 border-b border-border sticky top-0 bg-background">
                <h3 class="text-lg font-semibold">Add Token</h3>
                <button onclick="closeAddModal()" class="text-muted-foreground hover:text-foreground">
                    <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="p-5 space-y-4 max-h-[calc(100vh-200px)] overflow-y-auto">
                <!-- Session Token -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Session Token (ST) <span class="text-red-500">*</span></label>
                    <textarea id="addTokenST" rows="3" class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono resize-none" placeholder="Enter Session Token" required></textarea>
                    <p class="text-xs text-muted-foreground">Get __Secure-next-auth.session-token from browser cookies, will auto-convert to Access Token on save</p>
                </div>

                <!-- Remark -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Remark <span class="text-muted-foreground text-xs">- ÂèØÈÄâ</span></label>
                    <input id="addTokenRemark" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="AddRemark‰ø°ÊÅØ">
                </div>

                <!-- Project ID -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Project ID <span class="text-muted-foreground text-xs">- ÂèØÈÄâ</span></label>
                    <input id="addTokenProjectId" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono" placeholder="Leave empty for auto-generation">
                    <p class="text-xs text-muted-foreground">Enter existing Project ID or leave empty to create new project</p>
                </div>

                <!-- Project Name -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Project Name <span class="text-muted-foreground text-xs">- ÂèØÈÄâ</span></label>
                    <input id="addTokenProjectName" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="Leave empty for auto-generation (Â¶Ç: Jan 01 - 12:00)">
                </div>

                <!-- ÂäüËÉΩÂºÄÂÖ≥ -->
                <div class="space-y-3 pt-2 border-t border-border">
                    <label class="text-sm font-medium">ÂäüËÉΩÂºÄÂÖ≥</label>
                    <div class="space-y-2">
                        <div class="flex items-center gap-3">
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="addTokenImageEnabled" checked class="h-4 w-4 rounded border-input">
                                <span class="text-sm font-medium">EnableImageÁîüÊàê</span>
                            </label>
                            <input type="number" id="addTokenImageConcurrency" value="-1" class="flex h-8 w-20 rounded-md border border-input bg-background px-2 py-1 text-sm" placeholder="Âπ∂ÂèëÊï∞" title="Âπ∂ÂèëÊï∞ÈáèÈôêÂà∂ÔºöËÆæÁΩÆÂêåÊó∂Â§ÑÁêÜÁöÑÊúÄÂ§ßËØ∑Ê±ÇÊï∞„ÄÇ-1Ë°®Á§∫‰∏çÈôêÂà∂">
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex items-center gap-3">
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="addTokenVideoEnabled" checked class="h-4 w-4 rounded border-input">
                                <span class="text-sm font-medium">EnableVideoÁîüÊàê</span>
                            </label>
                            <input type="number" id="addTokenVideoConcurrency" value="-1" class="flex h-8 w-20 rounded-md border border-input bg-background px-2 py-1 text-sm" placeholder="Âπ∂ÂèëÊï∞" title="Âπ∂ÂèëÊï∞ÈáèÈôêÂà∂ÔºöËÆæÁΩÆÂêåÊó∂Â§ÑÁêÜÁöÑÊúÄÂ§ßËØ∑Ê±ÇÊï∞„ÄÇ-1Ë°®Á§∫‰∏çÈôêÂà∂">
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex items-center justify-end gap-3 p-5 border-t border-border sticky bottom-0 bg-background">
                <button onclick="closeAddModal()" class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-9 px-5">Cancel</button>
                <button id="addTokenBtn" onclick="submitAddToken()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-5">
                    <span id="addTokenBtnText">Add</span>
                    <svg id="addTokenBtnSpinner" class="hidden animate-spin h-4 w-4 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Token Ê®°ÊÄÅÊ°Ü -->
    <div id="editModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-background rounded-lg border border-border w-full max-w-2xl shadow-xl my-auto">
            <div class="flex items-center justify-between p-5 border-b border-border sticky top-0 bg-background">
                <h3 class="text-lg font-semibold">Edit Token</h3>
                <button onclick="closeEditModal()" class="text-muted-foreground hover:text-foreground">
                    <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="p-5 space-y-4 max-h-[calc(100vh-200px)] overflow-y-auto">
                <input type="hidden" id="editTokenId">

                <!-- Session Token -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Session Token (ST) <span class="text-red-500">*</span></label>
                    <textarea id="editTokenST" rows="3" class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono resize-none" placeholder="Enter Session Token" required></textarea>
                    <p class="text-xs text-muted-foreground">Get __Secure-next-auth.session-token from browser cookies, will auto-convert to Access Token on save</p>
                </div>

                <!-- Remark -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Remark <span class="text-muted-foreground text-xs">- ÂèØÈÄâ</span></label>
                    <input id="editTokenRemark" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="AddRemark‰ø°ÊÅØ">
                </div>

                <!-- Project ID -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Project ID <span class="text-muted-foreground text-xs">- ÂèØÈÄâ</span></label>
                    <input id="editTokenProjectId" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono" placeholder="Ëã•‰∏çÂ°´ÂÜôÂàô‰øùÊåÅÂéüÊúâÂÄº">
                    <p class="text-xs text-muted-foreground">‰øÆÊîπProject ID‰ºöUpdateToken‰ΩøÁî®ÁöÑÈ°πÁõÆ</p>
                </div>

                <!-- Project Name -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Project Name <span class="text-muted-foreground text-xs">- ÂèØÈÄâ</span></label>
                    <input id="editTokenProjectName" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="Ëã•‰∏çÂ°´ÂÜôÂàô‰øùÊåÅÂéüÊúâÂÄº">
                </div>

                <!-- ÂäüËÉΩÂºÄÂÖ≥ -->
                <div class="space-y-3 pt-2 border-t border-border">
                    <label class="text-sm font-medium">ÂäüËÉΩÂºÄÂÖ≥</label>
                    <div class="space-y-2">
                        <div class="flex items-center gap-3">
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="editTokenImageEnabled" class="h-4 w-4 rounded border-input">
                                <span class="text-sm font-medium">EnableImageÁîüÊàê</span>
                            </label>
                            <input type="number" id="editTokenImageConcurrency" class="flex h-8 w-20 rounded-md border border-input bg-background px-2 py-1 text-sm" placeholder="Âπ∂ÂèëÊï∞" title="Âπ∂ÂèëÊï∞ÈáèÈôêÂà∂ÔºöËÆæÁΩÆÂêåÊó∂Â§ÑÁêÜÁöÑÊúÄÂ§ßËØ∑Ê±ÇÊï∞„ÄÇ-1Ë°®Á§∫‰∏çÈôêÂà∂">
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex items-center gap-3">
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="editTokenVideoEnabled" class="h-4 w-4 rounded border-input">
                                <span class="text-sm font-medium">EnableVideoÁîüÊàê</span>
                            </label>
                            <input type="number" id="editTokenVideoConcurrency" class="flex h-8 w-20 rounded-md border border-input bg-background px-2 py-1 text-sm" placeholder="Âπ∂ÂèëÊï∞" title="Âπ∂ÂèëÊï∞ÈáèÈôêÂà∂ÔºöËÆæÁΩÆÂêåÊó∂Â§ÑÁêÜÁöÑÊúÄÂ§ßËØ∑Ê±ÇÊï∞„ÄÇ-1Ë°®Á§∫‰∏çÈôêÂà∂">
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex items-center justify-end gap-3 p-5 border-t border-border sticky bottom-0 bg-background">
                <button onclick="closeEditModal()" class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-9 px-5">Cancel</button>
                <button id="editTokenBtn" onclick="submitEditToken()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-5">
                    <span id="editTokenBtnText">Save</span>
                    <svg id="editTokenBtnSpinner" class="hidden animate-spin h-4 w-4 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Token Import Modal -->
    <div id="importModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
        <div class="bg-background rounded-lg border border-border w-full max-w-md shadow-xl">
            <div class="flex items-center justify-between p-5 border-b border-border">
                <h3 class="text-lg font-semibold">Import Token</h3>
                <button onclick="closeImportModal()" class="text-muted-foreground hover:text-foreground">
                    <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="p-5 space-y-4">
                <div>
                    <label class="text-sm font-medium mb-2 block">Select JSON file</label>
                    <input type="file" id="importFile" accept=".json" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                    <p class="text-xs text-muted-foreground mt-1">Select exported Token JSON file to import</p>
                </div>
                <div class="rounded-md bg-blue-50 dark:bg-blue-900/20 p-3 border border-blue-200 dark:border-blue-800">
                    <p class="text-xs text-blue-800 dark:text-blue-200">
                        <strong>Note:</strong>Existing emails will be updated, new emails will be added
                    </p>
                </div>
            </div>
            <div class="flex items-center justify-end gap-3 p-5 border-t border-border">
                <button onclick="closeImportModal()" class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-9 px-5">Cancel</button>
                <button id="importBtn" onclick="submitImportTokens()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-5">
                    <span id="importBtnText">Import</span>
                    <svg id="importBtnSpinner" class="hidden animate-spin h-4 w-4 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        let allTokens=[];
        const $=(id)=>document.getElementById(id),
        checkAuth=()=>{const t=localStorage.getItem('adminToken');return t||(location.href='/login',null),t},
        apiRequest=async(url,opts={})=>{const t=checkAuth();if(!t)return null;const r=await fetch(url,{...opts,headers:{...opts.headers,Authorization:`Bearer ${t}`,'Content-Type':'application/json'}});return r.status===401?(localStorage.removeItem('adminToken'),location.href='/login',null):r},
        loadStats=async()=>{try{const r=await apiRequest('/api/stats');if(!r)return;const d=await r.json();$('statTotal').textContent=d.total_tokens||0;$('statActive').textContent=d.active_tokens||0;$('statImages').textContent=(d.today_images||0)+'/'+(d.total_images||0);$('statVideos').textContent=(d.today_videos||0)+'/'+(d.total_videos||0);$('statErrors').textContent=(d.today_errors||0)+'/'+(d.total_errors||0)}catch(e){console.error('Failed to load stats:',e)}},
        loadTokens=async()=>{try{const r=await apiRequest('/api/tokens');if(!r)return;allTokens=await r.json();renderTokens()}catch(e){console.error('Failed to load tokens:',e)}},
        formatExpiry=exp=>{if(!exp)return'<span class="text-muted-foreground">-</span>';const d=new Date(exp),now=new Date(),diff=d-now;const dateStr=d.toLocaleDateString('en-US',{year:'numeric',month:'2-digit',day:'2-digit'}).replace(/\//g,'-');const timeStr=d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false});const hours=Math.floor(diff/36e5);if(diff<0)return`<span class="text-red-600 font-medium" title="Expired">Expired</span>`;if(hours<1)return`<span class="text-red-600 font-medium" title="${dateStr} ${timeStr}">${Math.floor(diff/6e4)}min</span>`;if(hours<24)return`<span class="text-orange-600 font-medium" title="${dateStr} ${timeStr}">${hours}hour</span>`;const days=Math.floor(diff/864e5);if(days<7)return`<span class="text-orange-600" title="${dateStr} ${timeStr}">${days}day</span>`;return`<span class="text-muted-foreground" title="${dateStr} ${timeStr}">${days}day</span>`},
        formatPlanType=type=>{if(!type)return'-';const typeMap={'chatgpt_team':'Team','chatgpt_plus':'Plus','chatgpt_pro':'Pro','chatgpt_free':'Free'};return typeMap[type]||type},
        formatSora2=(t)=>{if(t.sora2_supported===true){const remaining=t.sora2_total_count-t.sora2_redeemed_count;const tooltipText=`Invite code: ${t.sora2_invite_code||'None'}\nAvailable: ${remaining}/${t.sora2_total_count}\nUsed: ${t.sora2_redeemed_count}`;return`<div class="inline-flex items-center gap-1"><span class="inline-flex items-center rounded px-2 py-0.5 text-xs bg-green-50 text-green-700 cursor-pointer" title="${tooltipText}" onclick="copySora2Code('${t.sora2_invite_code||''}')">Supported</span><span class="text-xs text-muted-foreground" title="${tooltipText}">${remaining}/${t.sora2_total_count}</span></div>`}else if(t.sora2_supported===false){return`<span class="inline-flex items-center rounded px-2 py-0.5 text-xs bg-gray-100 text-gray-700 cursor-pointer" title="Click to activate with invite code" onclick="openSora2Modal(${t.id})">Not supported</span>`}else{return'-'}},
        formatPlanTypeWithTooltip=(t)=>{const tooltipText=t.subscription_end?`Plan expires: ${new Date(t.subscription_end).toLocaleDateString('en-US',{year:'numeric',month:'2-digit',day:'2-digit'}).replace(/\//g,'-')} ${new Date(t.subscription_end).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false})}`:'';return`<span class="inline-flex items-center rounded px-2 py-0.5 text-xs bg-blue-50 text-blue-700 cursor-pointer" title="${tooltipText||t.plan_title||'-'}">${formatPlanType(t.plan_type)}</span>`},
        formatSora2Remaining=(t)=>{if(t.sora2_supported===true){const remaining=t.sora2_remaining_count||0;return`<span class="text-xs">${remaining}</span>`}else{return'-'}},
        formatAccountType=(tier)=>{if(tier==='PAYGATE_TIER_NOT_PAID'){return`<span class="inline-flex items-center rounded px-2 py-0.5 text-xs bg-gray-100 text-gray-700">Normal</span>`}else{return`<span class="inline-flex items-center rounded px-2 py-0.5 text-xs bg-purple-50 text-purple-700">Member</span>`}},
        renderTokens=()=>{const tb=$('tokenTableBody');tb.innerHTML=allTokens.map(t=>{const imageDisplay=t.image_enabled?`${t.image_count||0}`:'-';const videoDisplay=t.video_enabled?`${t.video_count||0}`:'-';const creditsDisplay=t.credits!==undefined?`${t.credits}`:'-';const accountTypeDisplay=formatAccountType(t.user_paygate_tier);const projectDisplay=t.current_project_name||'-';const projectIdDisplay=t.current_project_id?(t.current_project_id.length>5?`<span class="cursor-pointer text-blue-600 hover:text-blue-700" onclick="copyProjectId('${t.current_project_id}')" title="${t.current_project_id}">${t.current_project_id.substring(0,5)}...</span>`:`<span class="cursor-pointer text-blue-600 hover:text-blue-700" onclick="copyProjectId('${t.current_project_id}')" title="${t.current_project_id}">${t.current_project_id}</span>`):'-';const expiryDisplay=formatExpiry(t.at_expires);return`<tr><td class="py-2.5 px-3">${t.email}</td><td class="py-2.5 px-3"><span class="inline-flex items-center rounded px-2 py-0.5 text-xs ${t.is_active?'bg-green-50 text-green-700':'bg-gray-100 text-gray-700'}">${t.is_active?'Active':'Disable'}</span></td><td class="py-2.5 px-3 text-xs">${expiryDisplay}</td><td class="py-2.5 px-3"><button onclick="refreshTokenCredits(${t.id})" class="inline-flex items-center gap-1 text-blue-600 hover:text-blue-700 text-sm" title="Click to refresh credits"><span>${creditsDisplay}</span><svg class="h-3 w-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 11-6.219-8.56"/><path d="M15 4.5l3.5 3.5L22 4.5"/></svg></button></td><td class="py-2.5 px-3">${accountTypeDisplay}</td><td class="py-2.5 px-3 text-xs">${projectDisplay}</td><td class="py-2.5 px-3 text-xs">${projectIdDisplay}</td><td class="py-2.5 px-3">${imageDisplay}</td><td class="py-2.5 px-3">${videoDisplay}</td><td class="py-2.5 px-3">${t.error_count||0}</td><td class="py-2.5 px-3 text-xs text-muted-foreground">${t.remark||'-'}</td><td class="py-2.5 px-3 text-right"><button onclick="refreshTokenAT(${t.id})" class="inline-flex items-center justify-center rounded-md hover:bg-blue-50 hover:text-blue-700 h-7 px-2 text-xs mr-1" title="RefreshAT">Update</button><button onclick="openEditModal(${t.id})" class="inline-flex items-center justify-center rounded-md hover:bg-green-50 hover:text-green-700 h-7 px-2 text-xs mr-1">Edit</button><button onclick="toggleToken(${t.id},${t.is_active})" class="inline-flex items-center justify-center rounded-md hover:bg-accent h-7 px-2 text-xs mr-1">${t.is_active?'Disable':'Enable'}</button><button onclick="deleteToken(${t.id})" class="inline-flex items-center justify-center rounded-md hover:bg-destructive/10 hover:text-destructive h-7 px-2 text-xs">Delete</button></td></tr>`}).join('')},
        refreshTokenCredits=async(id)=>{try{showToast('Refreshing credits...','info');const r=await apiRequest(`/api/tokens/${id}/refresh-credits`,{method:'POST'});if(!r)return;const d=await r.json();if(d.success){showToast(`Credits refreshed: ${d.credits}`,'success');await refreshTokens()}else{showToast('Refresh failed: '+(d.detail||'Unknown error'),'error')}}catch(e){showToast('Refresh failed: '+e.message,'error')}},
        refreshTokenAT=async(id)=>{try{showToast('Updating AT...','info');const r=await apiRequest(`/api/tokens/${id}/refresh-at`,{method:'POST'});if(!r)return;const d=await r.json();if(d.success){const expiresDate=d.token.at_expires?new Date(d.token.at_expires):null;const expiresStr=expiresDate?expiresDate.toLocaleString('en-US',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',hour12:false}).replace(/\//g,'-'):'Unknown';showToast(`AT updated! New expires: ${expiresStr}`,'success');await refreshTokens()}else{showToast('Update failed: '+(d.detail||'Unknown error'),'error')}}catch(e){showToast('Update failed: '+e.message,'error')}},
        refreshTokens=async()=>{await loadTokens();await loadStats()},
        openAddModal=()=>$('addModal').classList.remove('hidden'),
        closeAddModal=()=>{$('addModal').classList.add('hidden');$('addTokenST').value='';$('addTokenRemark').value='';$('addTokenProjectId').value='';$('addTokenProjectName').value='';$('addTokenImageEnabled').checked=true;$('addTokenVideoEnabled').checked=true;$('addTokenImageConcurrency').value='-1';$('addTokenVideoConcurrency').value='-1'},
        openEditModal=(id)=>{const token=allTokens.find(t=>t.id===id);if(!token)return showToast('Token not found','error');$('editTokenId').value=token.id;$('editTokenST').value=token.st||'';$('editTokenRemark').value=token.remark||'';$('editTokenProjectId').value=token.current_project_id||'';$('editTokenProjectName').value=token.current_project_name||'';$('editTokenImageEnabled').checked=token.image_enabled!==false;$('editTokenVideoEnabled').checked=token.video_enabled!==false;$('editTokenImageConcurrency').value=token.image_concurrency||'-1';$('editTokenVideoConcurrency').value=token.video_concurrency||'-1';$('editModal').classList.remove('hidden')},
        closeEditModal=()=>{$('editModal').classList.add('hidden');$('editTokenId').value='';$('editTokenST').value='';$('editTokenRemark').value='';$('editTokenProjectId').value='';$('editTokenProjectName').value='';$('editTokenImageEnabled').checked=true;$('editTokenVideoEnabled').checked=true;$('editTokenImageConcurrency').value='';$('editTokenVideoConcurrency').value=''},
        submitEditToken=async()=>{const id=parseInt($('editTokenId').value),st=$('editTokenST').value.trim(),remark=$('editTokenRemark').value.trim(),projectId=$('editTokenProjectId').value.trim(),projectName=$('editTokenProjectName').value.trim(),imageEnabled=$('editTokenImageEnabled').checked,videoEnabled=$('editTokenVideoEnabled').checked,imageConcurrency=$('editTokenImageConcurrency').value?parseInt($('editTokenImageConcurrency').value):null,videoConcurrency=$('editTokenVideoConcurrency').value?parseInt($('editTokenVideoConcurrency').value):null;if(!id)return showToast('Token ID invalid','error');if(!st)return showToast('Enter Session Token','error');const btn=$('editTokenBtn'),btnText=$('editTokenBtnText'),btnSpinner=$('editTokenBtnSpinner');btn.disabled=true;btnText.textContent='Saving...';btnSpinner.classList.remove('hidden');try{const r=await apiRequest(`/api/tokens/${id}`,{method:'PUT',body:JSON.stringify({st:st,remark:remark||null,project_id:projectId||null,project_name:projectName||null,image_enabled:imageEnabled,video_enabled:videoEnabled,image_concurrency:imageConcurrency,video_concurrency:videoConcurrency})});if(!r){btn.disabled=false;btnText.textContent='Save';btnSpinner.classList.add('hidden');return}const d=await r.json();if(d.success){closeEditModal();await refreshTokens();showToast('Token updated','success')}else{showToast('Update failed: '+(d.detail||d.message||'Unknown error'),'error')}}catch(e){showToast('Update failed: '+e.message,'error')}finally{btn.disabled=false;btnText.textContent='Save';btnSpinner.classList.add('hidden')}},
        convertST2AT=async()=>{const st=$('addTokenST').value.trim();if(!st)return showToast('Please enter Session Token first','error');try{showToast('Converting ST‚ÜíAT...','info');const r=await apiRequest('/api/tokens/st2at',{method:'POST',body:JSON.stringify({st:st})});if(!r)return;const d=await r.json();if(d.success&&d.access_token){$('addTokenAT').value=d.access_token;showToast('Conversion successful! AT auto-filled','success')}else{showToast('Conversion failed: '+(d.message||d.detail||'Unknown error'),'error')}}catch(e){showToast('Conversion failed: '+e.message,'error')}},
        convertEditST2AT=async()=>{const st=$('editTokenST').value.trim();if(!st)return showToast('Please enter Session Token first','error');try{showToast('Converting ST‚ÜíAT...','info');const r=await apiRequest('/api/tokens/st2at',{method:'POST',body:JSON.stringify({st:st})});if(!r)return;const d=await r.json();if(d.success&&d.access_token){$('editTokenAT').value=d.access_token;showToast('Conversion successful! AT auto-filled','success')}else{showToast('Conversion failed: '+(d.message||d.detail||'Unknown error'),'error')}}catch(e){showToast('Conversion failed: '+e.message,'error')}},
        submitAddToken=async()=>{const st=$('addTokenST').value.trim(),remark=$('addTokenRemark').value.trim(),projectId=$('addTokenProjectId').value.trim(),projectName=$('addTokenProjectName').value.trim(),imageEnabled=$('addTokenImageEnabled').checked,videoEnabled=$('addTokenVideoEnabled').checked,imageConcurrency=parseInt($('addTokenImageConcurrency').value)||(-1),videoConcurrency=parseInt($('addTokenVideoConcurrency').value)||(-1);if(!st)return showToast('Enter Session Token','error');const btn=$('addTokenBtn'),btnText=$('addTokenBtnText'),btnSpinner=$('addTokenBtnSpinner');btn.disabled=true;btnText.textContent='Adding...';btnSpinner.classList.remove('hidden');try{const r=await apiRequest('/api/tokens',{method:'POST',body:JSON.stringify({st:st,remark:remark||null,project_id:projectId||null,project_name:projectName||null,image_enabled:imageEnabled,video_enabled:videoEnabled,image_concurrency:imageConcurrency,video_concurrency:videoConcurrency})});if(!r){btn.disabled=false;btnText.textContent='Add';btnSpinner.classList.add('hidden');return}const d=await r.json();if(d.success){closeAddModal();await refreshTokens();showToast('Token added','success')}else{showToast('Add failed: '+(d.detail||d.message||'Unknown error'),'error')}}catch(e){showToast('Add failed: '+e.message,'error')}finally{btn.disabled=false;btnText.textContent='Add';btnSpinner.classList.add('hidden')}},
        testToken=async(id)=>{try{showToast('Testing token...','info');const r=await apiRequest(`/api/tokens/${id}/test`,{method:'POST'});if(!r)return;const d=await r.json();if(d.success&&d.status==='success'){let msg=`Token valid! User: ${d.email||'Unknown'}`;if(d.sora2_supported){const remaining=d.sora2_total_count-d.sora2_redeemed_count;msg+=`\nSora2: Supported (${remaining}/${d.sora2_total_count})`;if(d.sora2_remaining_count!==undefined){msg+=`\nAvailable: ${d.sora2_remaining_count}`}}showToast(msg,'success');await refreshTokens()}else{showToast(`Token invalid: ${d.message||'Unknown error'}`,'error')}}catch(e){showToast('Test failed: '+e.message,'error')}},
        toggleToken=async(id,isActive)=>{const action=isActive?'disable':'enable';try{const r=await apiRequest(`/api/tokens/${id}/${action}`,{method:'POST'});if(!r)return;const d=await r.json();d.success?(await refreshTokens(),showToast(isActive?'Token disabled':'Token enabled','success')):showToast('Action failed','error')}catch(e){showToast('Action failed: '+e.message,'error')}},
        toggleTokenStatus=async(id,active)=>{try{const r=await apiRequest(`/api/tokens/${id}/status`,{method:'PUT',body:JSON.stringify({is_active:active})});if(!r)return;const d=await r.json();d.success?(await refreshTokens(),showToast('Status updated','success')):showToast('Update failed','error')}catch(e){showToast('Update failed: '+e.message,'error')}},
        deleteToken=async(id,skipConfirm=false)=>{if(!skipConfirm&&!confirm('Are you sure you want to delete this token?'))return;try{const r=await apiRequest(`/api/tokens/${id}`,{method:'DELETE'});if(!r)return;const d=await r.json();if(d.success){await refreshTokens();if(!skipConfirm)showToast('Delete successful','success');return true}else{if(!skipConfirm)showToast('Delete failed','error');return false}}catch(e){if(!skipConfirm)showToast('Delete failed: '+e.message,'error');return false}},
        copySora2Code=async(code)=>{if(!code){showToast('No invite code to copy','error');return}try{if(navigator.clipboard&&navigator.clipboard.writeText){await navigator.clipboard.writeText(code);showToast(`Invite code copied: ${code}`,'success')}else{const textarea=document.createElement('textarea');textarea.value=code;textarea.style.position='fixed';textarea.style.opacity='0';document.body.appendChild(textarea);textarea.select();const success=document.execCommand('copy');document.body.removeChild(textarea);if(success){showToast(`Invite code copied: ${code}`,'success')}else{showToast('Copy failed: ÊµèËßàÂô®Not supported','error')}}}catch(e){showToast('Copy failed: '+e.message,'error')}},
        copyProjectId=async(projectId)=>{if(!projectId){showToast('No Project ID to copy','error');return}try{if(navigator.clipboard&&navigator.clipboard.writeText){await navigator.clipboard.writeText(projectId);showToast(`Project ID copied: ${projectId}`,'success')}else{const textarea=document.createElement('textarea');textarea.value=projectId;textarea.style.position='fixed';textarea.style.opacity='0';document.body.appendChild(textarea);textarea.select();const success=document.execCommand('copy');document.body.removeChild(textarea);if(success){showToast(`Project ID copied: ${projectId}`,'success')}else{showToast('Copy failed: ÊµèËßàÂô®Not supported','error')}}}catch(e){showToast('Copy failed: '+e.message,'error')}},
        openSora2Modal=(id)=>{$('sora2TokenId').value=id;$('sora2InviteCode').value='';$('sora2Modal').classList.remove('hidden')},
        closeSora2Modal=()=>{$('sora2Modal').classList.add('hidden');$('sora2TokenId').value='';$('sora2InviteCode').value=''},
        openImportModal=()=>{$('importModal').classList.remove('hidden');$('importFile').value=''},
        closeImportModal=()=>{$('importModal').classList.add('hidden');$('importFile').value=''},
        exportTokens=()=>{if(allTokens.length===0){showToast('No tokens to export','error');return}const exportData=allTokens.map(t=>({email:t.email,access_token:t.token,session_token:t.st||null,is_active:t.is_active,image_enabled:t.image_enabled!==false,video_enabled:t.video_enabled!==false,image_concurrency:t.image_concurrency||(-1),video_concurrency:t.video_concurrency||(-1)}));const dataStr=JSON.stringify(exportData,null,2);const dataBlob=new Blob([dataStr],{type:'application/json'});const url=URL.createObjectURL(dataBlob);const link=document.createElement('a');link.href=url;link.download=`tokens_${new Date().toISOString().split('T')[0]}.json`;document.body.appendChild(link);link.click();document.body.removeChild(link);URL.revokeObjectURL(url);showToast(`Exported ${allTokens.length} tokens`,'success')},
        submitImportTokens=async()=>{const fileInput=$('importFile');if(!fileInput.files||fileInput.files.length===0){showToast('Please select file','error');return}const file=fileInput.files[0];if(!file.name.endsWith('.json')){showToast('Please select JSON file','error');return}try{const fileContent=await file.text();const importData=JSON.parse(fileContent);if(!Array.isArray(importData)){showToast('JSON format error: should be array','error');return}if(importData.length===0){showToast('JSON file is empty','error');return}const btn=$('importBtn'),btnText=$('importBtnText'),btnSpinner=$('importBtnSpinner');btn.disabled=true;btnText.textContent='Importing...';btnSpinner.classList.remove('hidden');try{const r=await apiRequest('/api/tokens/import',{method:'POST',body:JSON.stringify({tokens:importData})});if(!r){btn.disabled=false;btnText.textContent='Import';btnSpinner.classList.add('hidden');return}const d=await r.json();if(d.success){closeImportModal();await refreshTokens();const msg=`Import successful! Added: ${d.added||0}, Update: ${d.updated||0}`;showToast(msg,'success')}else{showToast('Import failed: '+(d.detail||d.message||'Unknown error'),'error')}}catch(e){showToast('Import failed: '+e.message,'error')}finally{btn.disabled=false;btnText.textContent='Import';btnSpinner.classList.add('hidden')}}catch(e){showToast('File parse failed: '+e.message,'error')}},
        submitSora2Activate=async()=>{const tokenId=parseInt($('sora2TokenId').value),inviteCode=$('sora2InviteCode').value.trim();if(!tokenId)return showToast('Token ID invalid','error');if(!inviteCode)return showToast('Please enter invite code','error');if(inviteCode.length!==6)return showToast('Invite code must be 6 characters','error');const btn=$('sora2ActivateBtn'),btnText=$('sora2ActivateBtnText'),btnSpinner=$('sora2ActivateBtnSpinner');btn.disabled=true;btnText.textContent='Activating...';btnSpinner.classList.remove('hidden');try{showToast('Activating Sora2...','info');const r=await apiRequest(`/api/tokens/${tokenId}/sora2/activate?invite_code=${inviteCode}`,{method:'POST'});if(!r){btn.disabled=false;btnText.textContent='Activate';btnSpinner.classList.add('hidden');return}const d=await r.json();if(d.success){closeSora2Modal();await refreshTokens();if(d.already_accepted){showToast('Sora2 already activated (previously accepted)','success')}else{showToast(`Sora2 activated!Invite code: ${d.invite_code||'None'}`,'success')}}else{showToast('Activation failed: '+(d.message||'Unknown error'),'error')}}catch(e){showToast('Activation failed: '+e.message,'error')}finally{btn.disabled=false;btnText.textContent='Activate';btnSpinner.classList.add('hidden')}},
        loadAdminConfig=async()=>{try{const r=await apiRequest('/api/admin/config');if(!r)return;const d=await r.json();$('cfgErrorBan').value=d.error_ban_threshold||3;$('cfgAdminUsername').value=d.admin_username||'admin';$('cfgCurrentAPIKey').value=d.api_key||'';$('cfgDebugEnabled').checked=d.debug_enabled||false}catch(e){console.error('Failed to load config:',e)}},
        saveAdminConfig=async()=>{try{const r=await apiRequest('/api/admin/config',{method:'POST',body:JSON.stringify({error_ban_threshold:parseInt($('cfgErrorBan').value)||3})});if(!r)return;const d=await r.json();d.success?showToast('Config saved','success'):showToast('Save failed','error')}catch(e){showToast('Save failed: '+e.message,'error')}},
        updateAdminPassword=async()=>{const username=$('cfgAdminUsername').value.trim(),oldPwd=$('cfgOldPassword').value.trim(),newPwd=$('cfgNewPassword').value.trim();if(!oldPwd||!newPwd)return showToast('Please enter old and new password','error');if(newPwd.length<4)return showToast('New password must be at least 4 characters','error');try{const r=await apiRequest('/api/admin/password',{method:'POST',body:JSON.stringify({username:username||undefined,old_password:oldPwd,new_password:newPwd})});if(!r)return;const d=await r.json();if(d.success){showToast('Password changed, please re-login','success');setTimeout(()=>{localStorage.removeItem('adminToken');location.href='/login'},2000)}else{showToast('Change failed: '+(d.detail||'Unknown error'),'error')}}catch(e){showToast('Change failed: '+e.message,'error')}},
        updateAPIKey=async()=>{const newKey=$('cfgNewAPIKey').value.trim();if(!newKey)return showToast('Please enter new API Key','error');if(newKey.length<6)return showToast('API Key must be at least 6 characters','error');if(!confirm('Are you sure you want to update API Key? All clients need to use the new key after update.'))return;try{const r=await apiRequest('/api/admin/apikey',{method:'POST',body:JSON.stringify({new_api_key:newKey})});if(!r)return;const d=await r.json();if(d.success){showToast('API Key updated','success');$('cfgCurrentAPIKey').value=newKey;$('cfgNewAPIKey').value=''}else{showToast('Update failed: '+(d.detail||'Unknown error'),'error')}}catch(e){showToast('Update failed: '+e.message,'error')}},
        toggleDebugMode=async()=>{const enabled=$('cfgDebugEnabled').checked;try{const r=await apiRequest('/api/admin/debug',{method:'POST',body:JSON.stringify({enabled:enabled})});if(!r)return;const d=await r.json();if(d.success){showToast(enabled?'Debug mode enabled':'Debug mode disabled','success')}else{showToast('Action failed: '+(d.detail||'Unknown error'),'error');$('cfgDebugEnabled').checked=!enabled}}catch(e){showToast('Action failed: '+e.message,'error');$('cfgDebugEnabled').checked=!enabled}},
        loadProxyConfig=async()=>{try{const r=await apiRequest('/api/proxy/config');if(!r)return;const d=await r.json();$('cfgProxyEnabled').checked=d.proxy_enabled||false;$('cfgProxyUrl').value=d.proxy_url||''}catch(e){console.error('Failed to load proxy settings:',e)}},
        saveProxyConfig=async()=>{try{const r=await apiRequest('/api/proxy/config',{method:'POST',body:JSON.stringify({proxy_enabled:$('cfgProxyEnabled').checked,proxy_url:$('cfgProxyUrl').value.trim()})});if(!r)return;const d=await r.json();d.success?showToast('Proxy settings saved','success'):showToast('Save failed','error')}catch(e){showToast('Save failed: '+e.message,'error')}},
        toggleCacheOptions=()=>{const enabled=$('cfgCacheEnabled').checked;$('cacheOptions').style.display=enabled?'block':'none'},
        loadCacheConfig=async()=>{try{console.log('Loading cache settings...');const r=await apiRequest('/api/cache/config');if(!r){console.error('API request failed');return}const d=await r.json();console.log('Cache settings data:',d);if(d.success&&d.config){const enabled=d.config.enabled!==false;const timeout=d.config.timeout||7200;const baseUrl=d.config.base_url||'';const effectiveUrl=d.config.effective_base_url||'';console.log('Setting cache enabled:',enabled);console.log('Setting timeout:',timeout);console.log('Setting domain:',baseUrl);console.log('Effective URL:',effectiveUrl);$('cfgCacheEnabled').checked=enabled;$('cfgCacheTimeout').value=timeout;$('cfgCacheBaseUrl').value=baseUrl;if(effectiveUrl){$('cacheEffectiveUrlValue').textContent=effectiveUrl;$('cacheEffectiveUrl').classList.remove('hidden')}else{$('cacheEffectiveUrl').classList.add('hidden')}toggleCacheOptions();console.log('Cache settings loaded')}else{console.error('Cache settings data format error:',d)}}catch(e){console.error('Failed to load cache settings:',e);showToast('Failed to load cache settings: '+e.message,'error')}},
        loadGenerationTimeout=async()=>{try{console.log('Loading generation timeout settings...');const r=await apiRequest('/api/generation/timeout');if(!r){console.error('API request failed');return}const d=await r.json();console.log('Generation timeout settings data:',d);if(d.success&&d.config){const imageTimeout=d.config.image_timeout||300;const videoTimeout=d.config.video_timeout||1500;console.log('Setting image timeout:',imageTimeout);console.log('Setting video timeout:',videoTimeout);$('cfgImageTimeout').value=imageTimeout;$('cfgVideoTimeout').value=videoTimeout;console.log('Generation timeout settings loaded')}else{console.error('Generation timeout settings data format error:',d)}}catch(e){console.error('Failed to load generation timeout settings:',e);showToast('Failed to load generation timeout settings: '+e.message,'error')}},
        saveCacheConfig=async()=>{const enabled=$('cfgCacheEnabled').checked,timeout=parseInt($('cfgCacheTimeout').value)||7200,baseUrl=$('cfgCacheBaseUrl').value.trim();console.log('Saving cache settings:',{enabled,timeout,baseUrl});if(timeout<60||timeout>86400)return showToast('Cache timeout must be between 60-86400 seconds','error');if(baseUrl&&!baseUrl.startsWith('http://')&&!baseUrl.startsWith('https://'))return showToast('Domain must start with http:// or https://','error');try{console.log('Saving cache enabled status...');const r0=await apiRequest('/api/cache/enabled',{method:'POST',body:JSON.stringify({enabled:enabled})});if(!r0){console.error('Saving cache enabled statusrequest failed');return}const d0=await r0.json();console.log('Cache enabled status save result:',d0);if(!d0.success){console.error('Failed to save cache enabled status:',d0);return showToast('Failed to save cache enabled status','error')}console.log('Saving timeout...');const r1=await apiRequest('/api/cache/config',{method:'POST',body:JSON.stringify({timeout:timeout})});if(!r1){console.error('Saving timeoutrequest failed');return}const d1=await r1.json();console.log('Timeout save result:',d1);if(!d1.success){console.error('Failed to save timeout:',d1);return showToast('Failed to save timeout','error')}console.log('Saving domain...');const r2=await apiRequest('/api/cache/base-url',{method:'POST',body:JSON.stringify({base_url:baseUrl})});if(!r2){console.error('Saving domainrequest failed');return}const d2=await r2.json();console.log('Domain save result:',d2);if(d2.success){showToast('Cache settings saved','success');console.log('Waiting for config file write...');await new Promise(r=>setTimeout(r,200));console.log('Reloading config...');await loadCacheConfig()}else{console.error('Failed to save domain:',d2);showToast('Failed to save domain','error')}}catch(e){console.error('Save failed:',e);showToast('Save failed: '+e.message,'error')}},
        saveGenerationTimeout=async()=>{const imageTimeout=parseInt($('cfgImageTimeout').value)||300,videoTimeout=parseInt($('cfgVideoTimeout').value)||1500;console.log('Saving generation timeout settings:',{imageTimeout,videoTimeout});if(imageTimeout<60||imageTimeout>3600)return showToast('Image timeout must be between 60-3600 seconds','error');if(videoTimeout<60||videoTimeout>7200)return showToast('Video timeout must be between 60-7200 seconds','error');try{const r=await apiRequest('/api/generation/timeout',{method:'POST',body:JSON.stringify({image_timeout:imageTimeout,video_timeout:videoTimeout})});if(!r){console.error('Save request failed');return}const d=await r.json();console.log('Save result:',d);if(d.success){showToast('Generation timeout settings saved','success');await new Promise(r=>setTimeout(r,200));await loadGenerationTimeout()}else{console.error('Save failed:',d);showToast('Save failed','error')}}catch(e){console.error('Save failed:',e);showToast('Save failed: '+e.message,'error')}},
        toggleCaptchaOptions=()=>{const method=$('cfgCaptchaMethod').value;$('yescaptchaOptions').style.display=method==='yescaptcha'?'block':'none';$('browserCaptchaOptions').classList.toggle('hidden',method!=='browser')},
        toggleBrowserProxyInput=()=>{const enabled=$('cfgBrowserProxyEnabled').checked;$('browserProxyUrlInput').classList.toggle('hidden',!enabled)},
        loadCaptchaConfig=async()=>{try{console.log('Loading captcha settings...');const r=await apiRequest('/api/captcha/config');if(!r){console.error('API request failed');return}const d=await r.json();console.log('Captcha settings data:',d);$('cfgCaptchaMethod').value=d.captcha_method||'yescaptcha';$('cfgYescaptchaApiKey').value=d.yescaptcha_api_key||'';$('cfgYescaptchaBaseUrl').value=d.yescaptcha_base_url||'https://api.yescaptcha.com';$('cfgBrowserProxyEnabled').checked=d.browser_proxy_enabled||false;$('cfgBrowserProxyUrl').value=d.browser_proxy_url||'';toggleCaptchaOptions();toggleBrowserProxyInput();console.log('Captcha settings loaded')}catch(e){console.error('Failed to load captcha settings:',e);showToast('Failed to load captcha settings: '+e.message,'error')}},
        saveCaptchaConfig=async()=>{const method=$('cfgCaptchaMethod').value,apiKey=$('cfgYescaptchaApiKey').value.trim(),baseUrl=$('cfgYescaptchaBaseUrl').value.trim(),browserProxyEnabled=$('cfgBrowserProxyEnabled').checked,browserProxyUrl=$('cfgBrowserProxyUrl').value.trim();console.log('Saving captcha settings:',{method,apiKey,baseUrl,browserProxyEnabled,browserProxyUrl});try{const r=await apiRequest('/api/captcha/config',{method:'POST',body:JSON.stringify({captcha_method:method,yescaptcha_api_key:apiKey,yescaptcha_base_url:baseUrl,browser_proxy_enabled:browserProxyEnabled,browser_proxy_url:browserProxyUrl})});if(!r){console.error('Save request failed');return}const d=await r.json();console.log('Save result:',d);if(d.success){showToast('Captcha settings saved','success');await new Promise(r=>setTimeout(r,200));await loadCaptchaConfig()}else{console.error('Save failed:',d);showToast(d.message||'Save failed','error')}}catch(e){console.error('Save failed:',e);showToast('Save failed: '+e.message,'error')}},
        loadPluginConfig=async()=>{try{const r=await apiRequest('/api/plugin/config');if(!r)return;const d=await r.json();if(d.success&&d.config){$('cfgPluginConnectionUrl').value=d.config.connection_url||'';$('cfgPluginConnectionToken').value=d.config.connection_token||'';$('cfgAutoEnableOnUpdate').checked=d.config.auto_enable_on_update||false}}catch(e){console.error('Failed to load plugin config:',e);showToast('Failed to load plugin config: '+e.message,'error')}},
        savePluginConfig=async()=>{const token=$('cfgPluginConnectionToken').value.trim();const autoEnable=$('cfgAutoEnableOnUpdate').checked;try{const r=await apiRequest('/api/plugin/config',{method:'POST',body:JSON.stringify({connection_token:token,auto_enable_on_update:autoEnable})});if(!r)return;const d=await r.json();if(d.success){showToast('Êèí‰ª∂Config saved','success');await loadPluginConfig()}else{showToast(d.message||'Save failed','error')}}catch(e){showToast('Save failed: '+e.message,'error')}},
        copyConnectionUrl=()=>{const url=$('cfgPluginConnectionUrl').value;if(!url){showToast('Connection URL is empty','error');return}navigator.clipboard.writeText(url).then(()=>showToast('Connection URL copied','success')).catch(()=>showToast('Copy failed','error'))},
        copyConnectionToken=()=>{const token=$('cfgPluginConnectionToken').value;if(!token){showToast('Connection Token is empty','error');return}navigator.clipboard.writeText(token).then(()=>showToast('Connection Token copied','success')).catch(()=>showToast('Copy failed','error'))},
        toggleATAutoRefresh=async()=>{try{const enabled=$('atAutoRefreshToggle').checked;const r=await apiRequest('/api/token-refresh/enabled',{method:'POST',body:JSON.stringify({enabled:enabled})});if(!r){$('atAutoRefreshToggle').checked=!enabled;return}const d=await r.json();if(d.success){showToast(enabled?'AT auto-refresh enabled':'AT auto-refresh disabled','success')}else{showToast('Action failed: '+(d.detail||'Unknown error'),'error');$('atAutoRefreshToggle').checked=!enabled}}catch(e){showToast('Action failed: '+e.message,'error');$('atAutoRefreshToggle').checked=!enabled}},
        loadATAutoRefreshConfig=async()=>{try{const r=await apiRequest('/api/token-refresh/config');if(!r)return;const d=await r.json();if(d.success&&d.config){$('atAutoRefreshToggle').checked=d.config.at_auto_refresh_enabled||false}else{console.error('AT auto-refresh config format error:',d)}}catch(e){console.error('Failed to load AT auto-refresh config:',e)}},
        loadLogs=async()=>{try{const r=await apiRequest('/api/logs?limit=100');if(!r)return;const logs=await r.json();window.allLogs=logs;const tb=$('logsTableBody');tb.innerHTML=logs.map(l=>`<tr><td class="py-2.5 px-3">${l.operation}</td><td class="py-2.5 px-3"><span class="text-xs ${l.token_email?'text-blue-600':'text-muted-foreground'}">${l.token_email||'Unknown'}</span></td><td class="py-2.5 px-3"><span class="inline-flex items-center rounded px-2 py-0.5 text-xs ${l.status_code===200?'bg-green-50 text-green-700':'bg-red-50 text-red-700'}">${l.status_code}</span></td><td class="py-2.5 px-3">${l.duration.toFixed(2)}</td><td class="py-2.5 px-3 text-xs text-muted-foreground">${l.created_at?new Date(l.created_at).toLocaleString('en-US'):'-'}</td><td class="py-2.5 px-3"><button onclick="showLogDetail(${l.id})" class="inline-flex items-center justify-center rounded-md hover:bg-blue-50 hover:text-blue-700 h-7 px-2 text-xs">View</button></td></tr>`).join('')}catch(e){console.error('Failed to load logs:',e)}},
        refreshLogs=async()=>{await loadLogs()},
        clearAllLogs=async()=>{if(!confirm('Are you sure you want to clear all logs? This action cannot be undone!'))return;try{const r=await apiRequest('/api/logs',{method:'DELETE'});if(!r)return;const d=await r.json();if(d.success){showToast('Logs cleared','success');await loadLogs()}else{showToast('Clear failed: '+(d.message||'Unknown error'),'error')}}catch(e){showToast('Clear failed: '+e.message,'error')}},
        showLogDetail=(logId)=>{const log=window.allLogs.find(l=>l.id===logId);if(!log){showToast('Log not found','error');return}const content=$('logDetailContent');let detailHtml='';if(log.status_code===200){try{const responseBody=log.response_body?JSON.parse(log.response_body):null;if(responseBody){if(responseBody.url){detailHtml+=`<div class="space-y-2"><h4 class="font-medium text-sm">Generated result</h4><div class="rounded-md border border-border p-3 bg-muted/30"><p class="text-sm mb-2"><span class="font-medium">File URL:</span></p><a href="${responseBody.url}" target="_blank" class="text-blue-600 hover:underline text-xs break-all">${responseBody.url}</a></div></div>`}else if(responseBody.data&&responseBody.data.length>0){const item=responseBody.data[0];if(item.url){detailHtml+=`<div class="space-y-2"><h4 class="font-medium text-sm">Generated result</h4><div class="rounded-md border border-border p-3 bg-muted/30"><p class="text-sm mb-2"><span class="font-medium">File URL:</span></p><a href="${item.url}" target="_blank" class="text-blue-600 hover:underline text-xs break-all">${item.url}</a></div></div>`}else{detailHtml+=`<div class="space-y-2"><h4 class="font-medium text-sm">Response data</h4><pre class="rounded-md border border-border p-3 bg-muted/30 text-xs overflow-x-auto">${JSON.stringify(responseBody,null,2)}</pre></div>`}}else{detailHtml+=`<div class="space-y-2"><h4 class="font-medium text-sm">Response data</h4><pre class="rounded-md border border-border p-3 bg-muted/30 text-xs overflow-x-auto">${JSON.stringify(responseBody,null,2)}</pre></div>`}}else{detailHtml+=`<div class="space-y-2"><h4 class="font-medium text-sm">Response info</h4><p class="text-sm text-muted-foreground">NoneResponse data</p></div>`}}catch(e){detailHtml+=`<div class="space-y-2"><h4 class="font-medium text-sm">Response data</h4><pre class="rounded-md border border-border p-3 bg-muted/30 text-xs overflow-x-auto">${log.response_body||'None'}</pre></div>`}}else{try{const responseBody=log.response_body?JSON.parse(log.response_body):null;if(responseBody&&responseBody.error){detailHtml+=`<div class="space-y-2"><h4 class="font-medium text-sm text-red-600">Error reason</h4><div class="rounded-md border border-red-200 p-3 bg-red-50"><p class="text-sm text-red-700">${responseBody.error.message||responseBody.error||'Unknown error'}</p></div></div>`}else if(log.response_body&&log.response_body!=='{}'){detailHtml+=`<div class="space-y-2"><h4 class="font-medium text-sm text-red-600">Error info</h4><pre class="rounded-md border border-red-200 p-3 bg-red-50 text-xs overflow-x-auto">${log.response_body}</pre></div>`}}catch(e){if(log.response_body&&log.response_body!=='{}'){detailHtml+=`<div class="space-y-2"><h4 class="font-medium text-sm text-red-600">Error info</h4><pre class="rounded-md border border-red-200 p-3 bg-red-50 text-xs overflow-x-auto">${log.response_body}</pre></div>`}}}detailHtml+=`<div class="space-y-2 pt-4 border-t border-border"><h4 class="font-medium text-sm">Basic info</h4><div class="grid grid-cols-2 gap-2 text-sm"><div><span class="text-muted-foreground">Actions:</span> ${log.operation}</div><div><span class="text-muted-foreground">Status code:</span> <span class="inline-flex items-center rounded px-2 py-0.5 text-xs ${log.status_code===200?'bg-green-50 text-green-700':'bg-red-50 text-red-700'}">${log.status_code}</span></div><div><span class="text-muted-foreground">Duration:</span> ${log.duration.toFixed(2)}s</div><div><span class="text-muted-foreground">Time:</span> ${log.created_at?new Date(log.created_at).toLocaleString('en-US'):'-'}</div></div></div>`;content.innerHTML=detailHtml;$('logDetailModal').classList.remove('hidden')},
        closeLogDetailModal=()=>{$('logDetailModal').classList.add('hidden')},
        showToast=(m,t='info')=>{const d=document.createElement('div'),bc={success:'bg-green-600',error:'bg-destructive',info:'bg-primary'};d.className=`fixed bottom-4 right-4 ${bc[t]||bc.info} text-white px-4 py-2.5 rounded-lg shadow-lg text-sm font-medium z-50 animate-slide-up`;d.textContent=m;document.body.appendChild(d);setTimeout(()=>{d.style.opacity='0';d.style.transition='opacity .3s';setTimeout(()=>d.parentNode&&document.body.removeChild(d),300)},2000)},
        logout=()=>{if(!confirm('Are you sure you want to logout?'))return;localStorage.removeItem('adminToken');location.href='/login'},
        switchTab=t=>{const cap=n=>n.charAt(0).toUpperCase()+n.slice(1);['tokens','settings','logs'].forEach(n=>{const active=n===t;$(`panel${cap(n)}`).classList.toggle('hidden',!active);$(`tab${cap(n)}`).classList.toggle('border-primary',active);$(`tab${cap(n)}`).classList.toggle('text-primary',active);$(`tab${cap(n)}`).classList.toggle('border-transparent',!active);$(`tab${cap(n)}`).classList.toggle('text-muted-foreground',!active)});if(t==='settings'){loadAdminConfig();loadProxyConfig();loadCacheConfig();loadGenerationTimeout();loadCaptchaConfig();loadPluginConfig();loadATAutoRefreshConfig()}else if(t==='logs'){loadLogs()}};
        window.addEventListener('DOMContentLoaded',()=>{checkAuth();refreshTokens();loadATAutoRefreshConfig()});
    </script>
</body>
</html>
